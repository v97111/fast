<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Fast-Cycle Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b1020; --card:#111831; --muted:#9aa4b2; --text:#e8ecf1;
      --good:#10b981; --bad:#ef4444; --accent:#3b82f6; --chip:#1f2a48; --border:#223058;
    }
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      background:radial-gradient(1200px 600px at 20% -10%,#162042 0%,var(--bg) 40%); color:var(--text); margin:0;
    }
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:rgba(11,16,32,.7);
      border-bottom:1px solid rgba(255,255,255,.06); padding:14px 16px; display:flex; align-items:center; justify-content:space-between;}
    h1{margin:0;font-size:18px}
    .container{padding:16px;max-width:1100px;width:100%;margin:0 auto}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;color:#fff;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .start{background:var(--good)} .stop{background:var(--bad)} .add{background:var(--accent)}
    .seg{background:#0f1a3a;border:1px solid var(--border);border-radius:10px;padding:2px;display:inline-flex}
    .seg button{background:transparent;border:0;color:#cfe4ff;padding:8px 10px;border-radius:8px;cursor:pointer}
    .seg button.active{background:#1b2a55}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
      border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);width:100%}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){.grid{grid-template-columns:1.2fr .8fr}.grid-3{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:1200px){.grid-3{grid-template-columns:repeat(3,1fr)}}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px}
    @media (max-width:480px){.kv{grid-template-columns:1fr}}
    .muted{color:var(--muted)}
    .chip{background:var(--chip);padding:2px 8px;border-radius:999px;display:inline-block;white-space:normal;overflow-wrap:anywhere}
    .chips{display:flex;flex-wrap:wrap;gap:6px;max-width:100%}
    .spinner{width:16px;height:16px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    table{width:100%;border-collapse:collapse;font-size:14px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    thead{background:#0f1a3a}
    th,td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}
    tr:last-child td{border-bottom:0}
    .pnl-pos{color:var(--good)} .pnl-neg{color:var(--bad)}
    @media (max-width:640px){.col-worker,.col-qty,.col-note{display:none}table{font-size:13px}}
    input[type="number"]{background:#0e1631;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:8px 10px;width:120px}
    details{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;padding:6px 10px}
    summary{cursor:pointer;color:var(--accent);font-weight:600;outline:none}
    .switch{position:relative;display:inline-block;width:42px;height:22px}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;inset:0;background:#32406f;border-radius:999px;transition:.2s}
    .slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:2px;background:white;border-radius:50%;transition:.2s}
    input:checked + .slider{background:#10b981}
    input:checked + .slider:before{transform:translateX(20px)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    
    /* Enhanced status badges and icons */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-scanning {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      animation: pulse 2s infinite;
    }
    .status-in-position {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
    }
    .status-selling {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      animation: blink 1s infinite;
    }
    .status-error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }
    
    /* Enhanced P&L styling */
    .pnl-display {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }
    .pnl-positive {
      color: #10b981;
      background: rgba(16, 185, 129, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .pnl-negative {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    /* Progress indicators */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 4px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .progress-fill.danger {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }
    
    /* Icons */
    .icon {
      font-style: normal;
      font-size: 14px;
    }
    
    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.6; }
    }
    
    /* Enhanced card hover effects */
    .card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0,0,0,.35);
    }
    
    /* Time display enhancement */
    .time-display {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    /* Price level indicators */
    .price-level {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
      font-size: 12px;
    }
    .price-level .label {
      color: var(--muted);
    }
    .price-level .value {
      font-family: monospace;
      font-weight: 600;
    }
    .tp-level { border-left: 3px solid #10b981; padding-left: 6px; }
    .sl-level { border-left: 3px solid #ef4444; padding-left: 6px; }
    .trail-level { border-left: 3px solid #f59e0b; padding-left: 6px; }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <header>
    <h1>‚ö° Fast-Cycle Bot</h1>
    <div class="row">
      <div class="seg" id="modeSeg">
        <button id="btnSafe" class="active" onclick="setMode('safe')">Safe</button>
        <button id="btnFast" onclick="setMode('fast')">Fast</button>
      </div>
      <button class="btn stop"  onclick="post('/api/stop-core')">Stop All</button>
      <div class="row">
        <input type="number" id="amt" min="10" step="1" value="20" />
        <button class="btn add" onclick="addWorker()">Add Card</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h3 style="margin:0 0 10px">Overview</h3>
        <div class="kv" id="global">
          <div>Mode:</div><div><span id="modeTxt">safe</span> <span class="muted">(Safe: stricter entries ‚Ä¢ Fast: more entries)</span></div>

          <div>Watchlist:</div>
          <div>Valid <span id="wlc">-</span> <span class="muted">(from <span id="wlt">-</span>)</span></div>

          <div>Starting Balance (USDT):</div><div id="startv">-</div>
          <div>Current Balance (USDT):</div><div id="curv">-</div>

          <div>Profit:</div>
          <div><span id="p_usd">-</span> <span class="muted">(<span id="p_pct">-</span>)</span></div>

          <div>How exits work:</div>
          <div>Sell for a quick profit at +{{ '%.2f' % tp_trigger_pct }}%. If price rises further (+{{ '%.2f' % trail_arm }}%), start a trailing take‚Äëprofit with {{ '%.2f' % trail_pct }}% giveback. Cut loss at ‚àí{{ '%.2f' % sl_pct }}%.</div>

          <div>Watchlist Symbols:</div>
          <div>
            <details>
              <summary>View Symbols ({{ watchlist_list|length }})</summary>
              <div class="chips" style="margin-top:8px">
                {% for sym in watchlist_list %}<span class="chip">{{ sym }}</span>{% endfor %}
              </div>
            </details>
          </div>
        </div>

        <hr style="border-color:#223058;margin:12px 0">
        <h3 style="margin:0 0 10px">Cards</h3>
        <div id="cards" class="grid-3"></div>
        <div class="muted" style="margin-top:6px">Each card spends the amount you set. It scans coins and buys only when rules match.</div>

        <!-- Debug (collapsible) -->
        <details style="margin-top:12px" id="dbgDetails">
          <summary>Why a buy didn‚Äôt happen (debug)</summary>
          <div class="card" style="margin-top:10px">
            <div class="row" style="justify-content:space-between; margin-bottom:8px">
              <label style="display:flex;align-items:center;gap:10px">
                <span>Debug:</span>
                <span class="switch"><input type="checkbox" id="dbgToggle" checked onchange="toggleDebug(this.checked)"><span class="slider"></span></span>
                <strong id="dbgState">ON</strong>
              </label>
              <div class="row">
                <button class="btn add" onclick="copyDebug()">Copy JSON</button>
                <a class="btn start" href="/api/debug/export?format=csv" target="_blank" rel="noopener">Download CSV</a>
                <a class="btn start" href="/api/debug/export?format=json" target="_blank" rel="noopener">Download JSON</a>
              </div>
            </div>

            <div class="row" id="dbg-counts" style="flex-wrap:wrap; gap:6px; margin-bottom:8px"></div>
            <div style="overflow:auto; max-width:100%; max-height:40vh">
              <table id="dbg-table">
                <thead>
                  <tr>
                    <th>Time (UTC)</th><th class="col-worker">Card</th><th>Coin</th><th>Reason</th>
                    <th>Day range</th><th>Trend</th><th>Volume</th><th class="col-note">Pattern</th>
                  </tr>
                </thead>
                <tbody id="dbg-body">
                  <tr><td colspan="8" class="muted">Collecting rejections‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:6px">Updates every 2s. Turning debug OFF stops recording new events.</div>
          </div>
        </details>
      </div>

      <!-- Right -->
      <div class="card">
        <h3 style="margin:0 0 10px">All Trade History</h3>
        <div style="overflow:auto; max-width:100%; max-height:70vh">
          <table id="trades">
            <thead>
              <tr>
                <th>Time (UAE)</th><th class="col-worker">Card</th><th>Coin</th><th>Action</th>
                <th>Price</th><th class="col-qty">Qty</th><th>PnL %</th><th class="col-note">Note</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:6px">Auto-refreshing every 2s (showing up to {{ recent_limit }} rows).</div>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.getElementById('tbody');
    const dbgBody = document.getElementById('dbg-body');
    const dbgCounts = document.getElementById('dbg-counts');

    function cls(v){ return (v>=0) ? 'pnl-pos' : 'pnl-neg'; }
    function fmt(v,d=2){ if(v===null||v===undefined||isNaN(v)) return '-'; return Number(v).toFixed(d); }
    
    // Enhanced P&L display helper
    function updatePnLDisplay(usdValue, pctValue) {
      const usdEl = document.getElementById('p_usd');
      const pctEl = document.getElementById('p_pct');
      
      if (usdValue == null || pctValue == null) {
        usdEl.innerHTML = '-';
        pctEl.innerHTML = '-';
        return;
      }
      
      const isPositive = usdValue >= 0;
      const arrow = isPositive ? '‚Üó' : '‚Üò';
      const colorClass = isPositive ? 'pnl-positive' : 'pnl-negative';
      
      usdEl.innerHTML = `<span class="${colorClass}">${arrow} ${isPositive?'+':''}${Number(usdValue).toFixed(2)} USDT</span>`;
      pctEl.innerHTML = `<span class="${colorClass}">${isPositive?'+':''}${Number(pctValue).toFixed(2)}%</span>`;
    }
    
    async function post(url, body){ await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:body?JSON.stringify(body):'{}'}); }
    async function addWorker(){ 
      const amt=parseFloat(document.getElementById('amt').value||'20'); 
      await post('/api/add-worker',{quote:amt}); 
      // No need to manually refresh with WebSocket - updates will come automatically
      if (!useWebSocket) await refresh(); 
    }
    async function stopWorker(id){ 
      await post('/api/stop-worker',{worker_id:id}); 
      if (!useWebSocket) await refresh(); 
    }
    async function setMode(mode){
      await post('/api/mode',{mode});
      document.getElementById('btnSafe').classList.toggle('active',mode==='safe');
      document.getElementById('btnFast').classList.toggle('active',mode==='fast');
      if (!useWebSocket) await refresh();
    }
    async function toggleDebug(enabled){
      await fetch('/api/debug/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled})});
      document.getElementById('dbgState').textContent = enabled ? 'ON' : 'OFF';
    }
    async function copyDebug(){
      try{
        const r = await fetch('/api/debug');
        const data = await r.json();
        const txt = JSON.stringify(data.events || [], null, 2);
        await navigator.clipboard.writeText(txt);
        alert('Debug JSON copied to clipboard!');
      }catch(e){ alert('Copy failed'); }
    }

    function toUae(dtIso){
      if(!dtIso) return '-';
      const d=new Date(dtIso);
      const fmt=new Intl.DateTimeFormat('en-GB',{timeZone:'Asia/Dubai',year:'2-digit',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      // Convert "13 Aug 25, 21:07" to "25/Aug/13 21:07"
      const parts=fmt.formatToParts(d);
      const p=Object.fromEntries(parts.filter(x=>x.type!=='literal').map(x=>[x.type,x.value]));
      return `${p.year}/${p.month}/${p.day} ${p.hour}:${p.minute}`;
    }

    function renderWorkers(workers){
      const wrap = document.getElementById('cards');
      wrap.innerHTML = '';
      if(!workers || !workers.length){
        wrap.innerHTML = '<div class="muted">No cards yet. Enter an amount then press "Add Card" to start.</div>';
        return;
      }
      workers.forEach(w=>{
        const scanning = (w.status==='scanning'||w.status==='buying'||w.status==='selling');
        const pnl = (w.last_pnl==null) ? '-' : (Number(w.last_pnl).toFixed(3)+'%');
        const sym = w.symbol || '-';
        const note = w.note || '-';

        // Enhanced status badge with icons
        function getStatusBadge(status, symbol) {
          let icon = '';
          let badgeClass = 'status-badge';
          
          switch(status) {
            case 'scanning':
              icon = 'üîç';
              badgeClass += ' status-scanning';
              break;
            case 'buying':
              icon = 'üìà';
              badgeClass += ' status-in-position';
              break;
            case 'in_position':
              icon = 'üí∞';
              badgeClass += ' status-in-position';
              break;
            case 'selling':
              icon = 'üìâ';
              badgeClass += ' status-selling';
              break;
            default:
              icon = '‚ùì';
              badgeClass += ' status-error';
          }
          
          return `<span class="${badgeClass}">${icon} ${status}</span>`;
        }

        // live PnL with enhanced styling
        const uPct = (w.unreal_pct==null) ? '-' : `${Number(w.unreal_pct).toFixed(3)}%`;
        const uUsd = (w.unreal_usd==null) ? '-' : `${(w.unreal_usd>=0?'+':'')+Number(w.unreal_usd).toFixed(3)} USDT`;
        const curP = (w.cur_price==null) ? '-' : Number(w.cur_price).toFixed(6);
        const entP = (w.entry_price==null) ? '-' : Number(w.entry_price).toFixed(6);

        // Enhanced P&L display
        function getPnLDisplay(pct, usd) {
          if (pct === '-') return `<div class="pnl-display">${pct} <span class="muted">(${usd})</span></div>`;
          
          const isPositive = w.unreal_pct >= 0;
          const pnlClass = isPositive ? 'pnl-positive' : 'pnl-negative';
          const arrow = isPositive ? '‚Üó' : '‚Üò';
          
          return `<div class="pnl-display">
            <span class="${pnlClass}">${arrow} ${pct}</span>
            <span class="muted">(${usd})</span>
          </div>`;
        }

        const tpP   = (w.tp_price==null) ? '-' : Number(w.tp_price).toFixed(6);
        const taP   = (w.trail_arm_price==null) ? '-' : Number(w.trail_arm_price).toFixed(6);
        const slP   = (w.sl_price==null) ? '-' : Number(w.sl_price).toFixed(6);

        // Enhanced price targets display
        function getPriceTargets() {
          if (tpP === '-' && taP === '-' && slP === '-') {
            return '<div class="muted">No active position</div>';
          }
          
          return `
            <div style="display: flex; flex-direction: column; gap: 4px; font-size: 12px;">
              ${tpP !== '-' ? `<div class="price-level tp-level"><span class="label">Take Profit:</span><span class="value">${tpP}</span></div>` : ''}
              ${taP !== '-' ? `<div class="price-level trail-level"><span class="label">Trail Start:</span><span class="value">${taP}</span></div>` : ''}
              ${slP !== '-' ? `<div class="price-level sl-level"><span class="label">Stop Loss:</span><span class="value">${slP}</span></div>` : ''}
            </div>
          `;
        }

        // time in trade with enhanced styling
        const started = w.started ? new Date(w.started) : null;
        let heldTxt = '-';
        if(started){
          const secs = Math.max(0, Math.floor((Date.now() - started.getTime())/1000));
          const h = Math.floor(secs/3600), m = Math.floor((secs%3600)/60), s = secs%60;
          heldTxt = `<span class="time-display">${h>0?String(h).padStart(2,'0')+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span>`;
        }

        // Progress indicator for position (if in position)
        function getProgressIndicator() {
          if (w.status !== 'in_position' || !w.cur_price || !w.entry_price) return '';
          
          const pct = w.unreal_pct || 0;
          const maxPct = 5; // Show progress up to ¬±5%
          const progressPct = Math.min(Math.abs(pct) / maxPct * 100, 100);
          const isDanger = pct < -1; // Red if losing > 1%
          
          return `
            <div style="margin: 4px 0;">
              <div style="font-size: 11px; color: var(--muted); margin-bottom: 2px;">Position Progress</div>
              <div class="progress-bar">
                <div class="progress-fill ${isDanger ? 'danger' : ''}" style="width: ${progressPct}%"></div>
              </div>
            </div>
          `;
        }

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between; margin-bottom:6px">
            <div><strong>Card #${w.id}</strong> ‚Ä¢ <span class="muted mono">${toUae(w.updated)}</span></div>
            <button class="btn stop" onclick="stopWorker(${w.id})">Stop</button>
          </div>
          <div class="kv" style="font-size: 13px;">
            <div>Budget:</div><div class="mono">${fmt(w.quote,2)} USDT</div>
            <div>Status:</div><div>${getStatusBadge(w.status, sym)}</div>
            <div>Coin:</div><div><strong>${sym}</strong></div>

            ${w.status === 'in_position' ? `
            <div>Buy Price:</div><div class="mono">${entP}</div>
            <div>Current Price:</div><div class="mono">${curP}</div>

            <div>Current P&L:</div>
            ${getPnLDisplay(uPct, uUsd)}
            
            ${getProgressIndicator()}

            <div>Price Targets:</div>
            <div>${getPriceTargets()}</div>

            <div>Time in Trade:</div><div>${heldTxt}</div>
            ` : ''}

            <div>Last Result:</div><div class="mono ${w.last_pnl !== null && w.last_pnl >= 0 ? 'pnl-pos' : w.last_pnl !== null ? 'pnl-neg' : ''}">${pnl}</div>
            <div>Note:</div><div class="muted" style="font-size: 12px;">${note}</div>
          </div>`;
        wrap.appendChild(card);
      });
    }

    function boolBadge(ok){ return ok ? '<span class="chip" style="background:#11361f;color:#86efac">OK</span>' : '<span class="chip" style="background:#3a0e12;color:#fca5a5">NO</span>'; }
    function renderDebugCounts(counts){
      dbgCounts.innerHTML=''; const keys=Object.keys(counts);
      if(keys.length===0){ dbgCounts.innerHTML='<span class="muted">No data yet</span>'; return; }
      keys.forEach(k=>{ const span=document.createElement('span'); span.className='chip'; span.textContent=`${k}: ${counts[k]}`; dbgCounts.appendChild(span); });
    }
    function renderDebugEvents(events){
      dbgBody.innerHTML='';
      if(!events || events.length===0){
        const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=8; td.className='muted'; td.textContent='No debug events yet.'; tr.appendChild(td); dbgBody.appendChild(tr); return;
      }
      events.forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${toUae(e.time)}</td>
          <td class="col-worker">${e.worker_id ?? ''}</td>
          <td>${e.symbol}</td>
          <td><span class="chip">${e.reason}</span></td>
          <td>${boolBadge(!!e.day_ok)}</td>
          <td>${boolBadge(!!e.ema_ok)}</td>
          <td>${boolBadge(!!e.vol_ok)}</td>
          <td class="col-note">${boolBadge(!!e.pattern_ok)}</td>`;
        dbgBody.appendChild(tr);
      });
    }

    async function refresh(){
      try{
        const st = await (await fetch('/api/status')).json();
        document.getElementById('modeTxt').textContent = st.mode || 'safe';
        document.getElementById('btnSafe').classList.toggle('active', st.mode==='safe');
        document.getElementById('btnFast').classList.toggle('active', st.mode==='fast');

        document.getElementById('dbgToggle').checked = !!st.debug_enabled;
        document.getElementById('dbgState').textContent = st.debug_enabled ? 'ON' : 'OFF';

        document.getElementById('wlc').textContent = st.watchlist_count ?? '-';
        document.getElementById('wlt').textContent = st.watchlist_total ?? '-';
        document.getElementById('startv').textContent = (st.start_net_usdt==null?'-':Number(st.start_net_usdt).toFixed(2));
        document.getElementById('curv').textContent   = (st.current_net_usdt==null?'-':Number(st.current_net_usdt).toFixed(2));
        const pusd=st.profit_usd, ppct=st.profit_pct;
        updatePnLDisplay(pusd, ppct);
        renderWorkers(st.workers||[]);
      }catch(e){}
      try{
        const data = await (await fetch('/api/trades')).json();
        const rows = data.rows || []; tbody.innerHTML='';
        if(rows.length===0){
          const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=8; td.className='muted'; td.textContent='No trades yet.'; tr.appendChild(td); tbody.appendChild(tr);
        }else{
          rows.forEach(r=>{
            const tr=document.createElement('tr'); const pnl=parseFloat(r.pnl_pct||'');
            tr.innerHTML = `
              <td>${toUae(r.time)}</td>
              <td class="col-worker">${r.worker_id||''}</td>
              <td>${r.symbol}</td>
              <td><span class="chip">${r.action}</span></td>
              <td>${r.price}</td>
              <td class="col-qty">${r.qty}</td>
              <td class="${isNaN(pnl)?'':(pnl>=0?'pnl-pos':'pnl-neg')}">${r.pnl_pct||''}</td>
              <td class="col-note">${r.note||''}</td>`;
            tbody.appendChild(tr);
          });
        }
      }catch(e){}
    }

    async function refreshDebug(){
      try{
        const r = await fetch('/api/debug');
        const data = await r.json();
        document.getElementById('dbgToggle').checked = !!data.enabled;
        document.getElementById('dbgState').textContent = data.enabled ? 'ON' : 'OFF';
        renderDebugCounts(data.counts || {});
        renderDebugEvents(data.events || []);
      }catch(e){}
    }

    // WebSocket Connection with fallback to polling
    let socket = null;
    let useWebSocket = true;
    let fallbackInterval = null;

    function initializeWebSocket() {
      try {
        socket = io();
        
        socket.on('connect', function() {
          console.log('WebSocket connected');
          useWebSocket = true;
          // Clear fallback polling if active
          if (fallbackInterval) {
            clearInterval(fallbackInterval);
            fallbackInterval = null;
          }
        });

        socket.on('disconnect', function() {
          console.log('WebSocket disconnected, falling back to polling');
          useWebSocket = false;
          startFallbackPolling();
        });

        socket.on('status_update', function(data) {
          if (useWebSocket) {
            updateStatus(data);
          }
        });

        socket.on('trades_update', function(data) {
          if (useWebSocket) {
            updateTrades(data);
          }
        });

        socket.on('debug_update', function(data) {
          if (useWebSocket) {
            updateDebug(data);
          }
        });

        socket.on('connect_error', function(error) {
          console.log('WebSocket connection error, falling back to polling:', error);
          useWebSocket = false;
          startFallbackPolling();
        });

      } catch (error) {
        console.log('WebSocket not available, using polling fallback:', error);
        useWebSocket = false;
        startFallbackPolling();
      }
    }

    function startFallbackPolling() {
      if (!fallbackInterval) {
        console.log('Starting fallback polling mode');
        fallbackInterval = setInterval(function() {
          if (!useWebSocket) {
            refresh();
            refreshDebug();
          }
        }, 2000);
      }
    }

    // Extract update logic from refresh functions for reuse
    function updateStatus(st) {
      try {
        document.getElementById('modeTxt').textContent = st.mode || 'safe';
        document.getElementById('btnSafe').classList.toggle('active', st.mode==='safe');
        document.getElementById('btnFast').classList.toggle('active', st.mode==='fast');

        document.getElementById('dbgToggle').checked = !!st.debug_enabled;
        document.getElementById('dbgState').textContent = st.debug_enabled ? 'ON' : 'OFF';

        document.getElementById('wlc').textContent = st.watchlist_count ?? '-';
        document.getElementById('wlt').textContent = st.watchlist_total ?? '-';
        document.getElementById('startv').textContent = (st.start_net_usdt==null?'-':Number(st.start_net_usdt).toFixed(2));
        document.getElementById('curv').textContent   = (st.current_net_usdt==null?'-':Number(st.current_net_usdt).toFixed(2));
        const pusd=st.profit_usd, ppct=st.profit_pct;
        updatePnLDisplay(pusd, ppct);
        renderWorkers(st.workers||[]);
      }catch(e){console.error('Error updating status:', e);}
    }

    function updateTrades(data) {
      try{
        const rows = data.rows || []; tbody.innerHTML='';
        if(rows.length===0){
          const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=8; td.className='muted'; td.textContent='No trades yet.'; tr.appendChild(td); tbody.appendChild(tr);
        }else{
          rows.forEach(r=>{
            const tr=document.createElement('tr'); const pnl=parseFloat(r.pnl_pct||'');
            tr.innerHTML = `
              <td>${toUae(r.time)}</td>
              <td class="col-worker">${r.worker_id||''}</td>
              <td>${r.symbol}</td>
              <td><span class="chip">${r.action}</span></td>
              <td>${r.price}</td>
              <td class="col-qty">${r.qty}</td>
              <td class="${isNaN(pnl)?'':(pnl>=0?'pnl-pos':'pnl-neg')}">${r.pnl_pct||''}</td>
              <td class="col-note">${r.note||''}</td>`;
            tbody.appendChild(tr);
          });
        }
      }catch(e){console.error('Error updating trades:', e);}
    }

    function updateDebug(data) {
      try{
        document.getElementById('dbgToggle').checked = !!data.enabled;
        document.getElementById('dbgState').textContent = data.enabled ? 'ON' : 'OFF';
        renderDebugCounts(data.counts || {});
        renderDebugEvents(data.events || []);
      }catch(e){console.error('Error updating debug:', e);}
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeWebSocket();
      post('/api/start-core').then(()=>{ 
        if (!useWebSocket) {
          refresh(); 
          refreshDebug(); 
        }
      });
    });
  </script>
</body>
</html>
