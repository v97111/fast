<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bot Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .card { @apply bg-slate-800/70 rounded-2xl p-4 shadow-lg border border-slate-700; }
  .badge { @apply text-xs px-2 py-1 rounded-full bg-slate-700 text-slate-200; }
  .btn  { @apply px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-500 disabled:opacity-50; }
  .btn-red { @apply bg-rose-600 hover:bg-rose-500; }
  .spinner { width:14px; height:14px; border:2px solid #64748b; border-top-color: transparent; border-radius:50%; animation:spin 0.9s linear infinite; display:inline-block; vertical-align:middle;}
  @keyframes spin { to { transform: rotate(360deg);} }
</style>
</head>
<body class="bg-slate-900 text-slate-100">
<div class="max-w-7xl mx-auto px-3 py-5">
  <header class="flex items-center justify-between mb-4">
    <h1 class="text-lg md:text-2xl font-semibold">âš¡ Fast-Cycle Bot</h1>
    <div class="flex gap-2">
      <button id="startBtn" class="btn">Start</button>
      <button id="stopBtn" class="btn btn-red">Stop</button>
      <button id="addCardBtn" class="btn">Add Card</button>
      <button id="clearCardsBtn" class="btn btn-red hidden md:inline-block">Clear Cards</button>
    </div>
  </header>

  <!-- Global -->
  <section class="card mb-4">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <div class="space-y-1">
        <div>Running: <span id="running" class="badge">-</span></div>
        <div>Mode: <span id="mode" class="badge">-</span></div>
        <div>Profit: <span id="profit" class="font-medium">-</span></div>
        <div class="text-xs text-slate-400">Auto-refresh every 2s</div>
      </div>

      <div class="flex flex-wrap gap-2">
        <label class="text-sm text-slate-300">Mode</label>
        <select id="modeSel" class="bg-slate-800 border border-slate-700 rounded-lg px-2 py-2">
          <option value="fast">Fast</option>
          <option value="safe">Safe</option>
        </select>

        <details class="bg-slate-800 border border-slate-700 rounded-lg px-2 py-2">
          <summary class="cursor-pointer">Edit watchlist</summary>
          <div class="mt-2">
            <textarea id="watchlist" rows="3" class="w-full md:w-80 bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs"></textarea>
            <div class="mt-2 flex gap-2">
              <button id="saveWatch" class="btn">Save</button>
            </div>
          </div>
        </details>

        <details class="bg-slate-800 border border-slate-700 rounded-lg px-2 py-2">
          <summary class="cursor-pointer">Debug</summary>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <label class="text-sm">Enabled</label>
            <input id="debugToggle" type="checkbox" checked class="accent-emerald-500">
            <button id="copyDebug" class="btn">Copy</button>
            <button id="exportDebug" class="btn">Export</button>
          </div>
          <pre id="debugBox" class="mt-2 max-h-64 overflow-auto text-xs bg-slate-900 p-2 rounded-lg"></pre>
        </details>
      </div>
    </div>
  </section>

  <!-- Workers -->
  <section class="card">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-semibold">Worker Cards</h2>
      <button id="clearCardsBtn2" class="btn btn-red md:hidden">Clear Cards</button>
    </div>
    <div id="workers" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3"></div>
  </section>

  <!-- Trades -->
  <section class="card mt-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-semibold">Trade History</h2>
      <span id="tradeCount" class="badge">0</span>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="text-slate-300">
          <tr class="text-left">
            <th class="py-2 pr-3">Time</th>
            <th class="py-2 pr-3">Worker</th>
            <th class="py-2 pr-3">Side</th>
            <th class="py-2 pr-3">Symbol</th>
            <th class="py-2 pr-3">Price</th>
            <th class="py-2 pr-3">Amount</th>
            <th class="py-2 pr-3">PnL %</th>
          </tr>
        </thead>
        <tbody id="trades"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
const API = ""; // same origin
const $ = (id)=>document.getElementById(id);

async function jget(url){ const r=await fetch(url); return r.json(); }
async function jpost(url, body){ const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body||{})}); return r.json(); }

async function loadStatus() {
  const s = await jget(`${API}/api/status`);
  $("running").textContent = s.running ? "Yes" : "No";
  $("mode").textContent = s.mode;
  $("modeSel").value = s.mode;
  $("watchlist").value = s.watchlist;
  const p = s.profit || {abs:0,pct:0};
  $("profit").textContent = `${(p.abs||0).toFixed(2)} USDT (${(p.pct||0).toFixed(2)}%)`;
  renderWorkers(s.workers || {});
}
function renderWorkers(map){
  const container = $("workers");
  container.innerHTML = "";
  Object.values(map).forEach(w=>{
    const div = document.createElement("div");
    div.className = "card";
    const spinner = (w.status==="idle" || w.status==="scanning") ? '<span class="spinner"></span>' : '';
    const pos = w.position;
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-medium">Card #${w.id}</div>
        <div class="text-xs text-slate-400">${w.started_at || ""}</div>
      </div>
      <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
        <div>Amount</div><div class="text-right">${(w.amount||0).toFixed(2)} USDT</div>
        <div>Status</div><div class="text-right">${w.status} ${spinner}</div>
        <div>Symbol</div><div class="text-right">${w.symbol || "-"}</div>
        <div>Note</div><div class="text-right">${w.note || "-"}</div>
        ${pos ? `
          <div>Entry</div><div class="text-right">${pos.buy_price?.toFixed ? pos.buy_price.toFixed(6) : pos.buy_price}</div>
          <div>Qty</div><div class="text-right">${pos.qty?.toFixed ? pos.qty.toFixed(6) : pos.qty}</div>
        ` : ``}
      </div>
    `;
    container.appendChild(div);
  });
}

async function loadTrades(){
  const list = await jget(`${API}/api/trades`);
  $("tradeCount").textContent = list.length;
  const tb = $("trades");
  tb.innerHTML = "";
  list.slice().reverse().forEach(t=>{
    const tr = document.createElement("tr");
    tr.className="border-t border-slate-800";
    tr.innerHTML = `
      <td class="py-2 pr-3">${(t.time||"").replace('T',' ').replace('+00:00','')}</td>
      <td class="py-2 pr-3">${t.worker || ""}</td>
      <td class="py-2 pr-3">${t.side || ""}</td>
      <td class="py-2 pr-3">${t.symbol || ""}</td>
      <td class="py-2 pr-3">${t.price?.toFixed ? t.price.toFixed(6) : t.price || ""}</td>
      <td class="py-2 pr-3">${t.amount?.toFixed ? t.amount.toFixed(2) : t.amount || ""}</td>
      <td class="py-2 pr-3">${t.pnl_pct!==undefined ? t.pnl_pct.toFixed(2) : ""}</td>
    `;
    tb.appendChild(tr);
  });
}

async function loadDebug(){
  const items = await jget(`${API}/api/debug?limit=300`);
  $("debugBox").textContent = JSON.stringify(items, null, 2);
}

$("startBtn").onclick = ()=> jpost(`${API}/api/start`).then(loadStatus);
$("stopBtn").onclick = ()=> jpost(`${API}/api/stop`).then(loadStatus);
$("addCardBtn").onclick = async ()=>{
  const amt = prompt("Amount in USDT per card:", "20");
  if(!amt) return;
  await jpost(`${API}/api/workers/add`, {amount: parseFloat(amt)});
  await loadStatus();
};
["clearCardsBtn","clearCardsBtn2"].forEach(id=>{
  const el = $(id);
  if(el){ el.onclick = async ()=>{ await jpost(`${API}/api/workers/clear`); await loadStatus(); }; }
});

$("modeSel").onchange = async (e)=>{
  await jpost(`${API}/api/mode`, {mode: e.target.value});
  await loadStatus();
};
$("saveWatch").onclick = async ()=>{
  await jpost(`${API}/api/watchlist`, {watchlist: $("watchlist").value});
  await loadStatus();
};
$("debugToggle").onchange = async (e)=>{
  await jpost(`${API}/api/debug/toggle`, {on: e.target.checked});
  await loadDebug();
};
$("copyDebug").onclick = ()=>{
  navigator.clipboard.writeText($("debugBox").textContent||"");
};
$("exportDebug").onclick = ()=>{
  const blob = new Blob([$(`debugBox`).textContent||""], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `debug_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
};

async function tick(){
  await loadStatus();
  await loadTrades();
  await loadDebug();
}
tick();
setInterval(tick, 2000);
</script>
</body>
</html>
